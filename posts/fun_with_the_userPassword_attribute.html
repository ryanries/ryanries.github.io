<h1><a href="./?title=fun_with_the_userPassword_attribute.html">Fun with the userPassword Attribute</a></h1>
<p>January 19th, 2024</p>
<p>A customer recently had some questions about password storage in Active Directory. More accurately, the <i>security auditors</i> of this customer had some questions about password storage in Active Directory.</p>
<p>Specifically, they had an application that used <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/f3adda9f-89e1-4340-a3f2-1f0a6249f1f8">the userPassword attribute</a> in AD. It was some home-grown Java-based system; a typical enterprise application.</p>
<p>The userPassword attribute is an inetOrgPerson thing for nix systems and other 3rd-party systems that interoperate with other x.500 LDAP directories. Nothing in Windows uses that attribute, nor does any other Microsoft product that I know of.</p>
<p>But the concern was about whether the userPassword attribute was encrypted at rest, like how unicodePwd or supplementalCredentials is.</p>
<p>The short answer is no, it is not encrypted.</p>
<p>The long answer is significantly more complicated.</p>
<p>Although the gory details of exactly how Active Directory encrypts data stored in its database, ntds.dit, have been fully explored and published by security researchers, reverse engineers and hackers, those details have never been well-documented (or documented at all) by Microsoft themselves. And I'm sure that was intentional, at least originally. It was probably once a proudly-kept trade secret... back in 2003. But now in 2024, the cat is out of the bag. The cat left the bag many years ago. Everybody knows about syskey and the PEK and tools like mimikatz and DSInternals and on and on. Not a secret at all anymore.</p>
<p>But I digress. Back to the userPassword attribute.</p>
<p>The userPassword attribute has two modes of operation. These two modes are controlled by the 9th character of <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e5899be4-862e-496f-9a38-33950617d2c5">the dsHeuristics attribute</a>. By default, this flag in dsHeuristics, also known as the fUserPwdSupport flag, is off for Active Directory, but on for ADLDS.</p>
<p>When fUserPwdSupport is turned off, as it is by default in AD, then the userPassword attribute is treated just like any other ordinary attribute, and it is given no special considerations. That means you can store whatever kind of data you want to store in that attribute, and it will be <b>unencrypted plain text</b>, and anyone with permissions will be able to freely query the attribute.</p>
<p>Here is an example of setting the userPassword attribute of our fictitious user Terrence Mcswiggan using an ldifde import, and then querying for the attribute using the Get-ADUser PowerShell cmdlet. Notice the password is right there in plain text:</p>
<img src="posts/images/2024/userPasswordAttribute01.png" alt="userPassword attribute example 1" title="userPassword attribute example 1">
<p>If you're guilty of storing passwords like this, the patron saint of infosec will curse your entire blood line.</p>
<p>(There was a very old and buggy version of ktpass.exe that erroneously stored plain text passwords in the userPassword attribute... but that bug was fixed like 20 years ago.)</p>
<p>Now let's say you then set that flag in your dsHeuristics attribute: 000000001. You've now enabled fUserPwdSupport:</p>
<img src="posts/images/2024/userPasswordAttribute01.png" alt="dsHeuristics" title="dsHeuristics">
<p>What happens now is the userPassword attribute is treated differently. The first thing you are likely to notice is that now you can no longer query for that attribute at all, not even as Domain Admin:</p>
<img src="posts/images/2024/userPasswordAttribute03.png" alt="userPassword attribute example 2" title="userPassword attribute example 2">
<p>You are also now allowed to update a user's actual Windows password by using the userPassword attribute. What this means is that writes to the userPassword attribute are redirected to the unicodePwd attribute, as if you had performed a modify operation on the unicodePwd attribute instead. The contents of the userPassword attribute are not touched. To change a user's password by using the userPassword attribute, you must adhere to the same rules as when changing the unicodePwd attribute, which means SSL/TLS or SASL required. So for this next part, I needed to perform the attribute update over LDAPS:</p>
<img src="posts/images/2024/userPasswordAttribute04.png" alt="userPassword attribute example 3" title="userPassword attribute example 3">
<p>There's a lot going on in the screenshot above - let me explain: First, bear with me as I had some Hyper-V issues during the middle of this experiment and had to switch labs, so the distinguished name is a little different. Yet I stuck with the randomly-generated name Terrence Mcswiggan. I like that name. I feel like he might be a recurring character in my future labs.</p>
<p>At the top of the screenshot you will see that I have used a text file named userpassword.ldf as the import file for an ldifde operation. That ldifde operation performs an LDAP modify on the userPassword attribute of the user.</p>
<p>After that ldifde operation was finished, I checked the output of repadmin /showobjmeta. This command shows us that even though we just ran that LDAP modify operation against the userPassword attribute, the userPassword attribute was not updated. The ldifde command was run at 22:38. You can see that the unicodePwd, ntPwdHistory, and supplementalCredentials attributes of this user were updated at 22:38. But not userPassword. The LDAP modify against the userPassword attribute was redirected to be like a standard "Windows-style" password change instead. Nothing was stored in the userPassword attribute.</p>
<p>This can be further proven by examining the ntds.dit database offline with an ESE database viewer such as <a href="https://www.nirsoft.net/utils/ese_database_view.html">ESEDatabaseView from NirSoft</a>:</p>
<img src="posts/images/2024/userPasswordAttribute05.png" alt="userPassword attribute example 4" title="userPassword attribute example 4">
<p>In the above screenshot, we are looking at the physical ESE database from my Active Directory lab. The column ATTk35 corresponds to the userPassword attribute. We can see that even after the password change, with fUserPwdSupport enabled via dsHeuristics, that nothing is physically stored in the userPassword attribute.</p>
<p>For reference, the column ATTm131085 is displayName, and column ATTk589914 corresponds to unicodePwd, which is encrypted.</p>
<p>One final note: If you start storing plain-text, unencrypted data in the userPassword field, and then later proceed to change the dsHeuristics value to enable fUserPwdSupport, keep in mind that even though the userPassword attribute can no longer be queried while the DC is online, the old plain-text data will still persist there in the userPassword attribute forever. That attribute is not actively cleared just because you changed dsHeuristics. If an attacker did manage to gain access to a copy of your ntds.dit, they would find whatever old, stale passwords were in that userPassword attribute from before when you changed the dsHeuristics value.</p>
<p>So keep rotating those passwords, friends.</p>