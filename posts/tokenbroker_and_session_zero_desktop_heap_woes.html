<h1><a href="./?title=tokenbroker_and_session_zero_desktop_heap_woes.html">TokenBroker and Session 0 Desktop Heap Woes</a></h1>
<p>March 20, 2024</p>
<p>Have you ever been staring at a "Credentials needed" prompt in Outlook or Teams, even though there's nothing wrong with your credentials? Maybe you get an error dialog box that says something like "We couldn't sign you in" or "Something went wrong" with a generic and useless error code like 1001? If you have, then sit a while, and listen...</p>
<img src="posts/images/2024/signin1001.png" alt="Error something went wrong [1001]" title="Error something went wrong [1001]">
<p>Even though I specialize in on-prem Active Directory, my job title is Windows Escalation Engineer, which means I need to be familiar with all aspects of Windows OS internals to some degree, and I need to be prepared to step into areas of the Windows OS I don't have a lot of familiarity with. Even when it doesn't have much at all to do with AD.</p>
<p>My predilection is to pluck customer tickets out of the queue that have something to do with LDAP, or Kerberos, or AD replication, or TLS certificates, or Group Policy, etc.. That's where I'm most comfortable. But lately, a rash of customer problems have come in that, while yes, are a form of authentication, but it's Azure AD authentication via TokenBroker/Web Account Manager and has nothing to do with AD. But since it's some form of authentication, any and all auth problems come to me. The AD guy. So as is often required in this job role, I've had to step out of my comfort zone and seize the opportunity to learn some new tricks.</p>
<p>The more TokenBroker cases I work, the more I become the de-facto TokenBroker guy on my team, even against my will. I don't really want to be the TokenBroker guy, but here we are.</p>
<p>TokenBroker, also known as Web Account Manager (WAM,) runs as a Windows background service. Its job is to authenticate you to various web services such as Azure AD, Xbox, OneDrive, Teams, M365 Outlook, etc. Various authentication flows within Windows use it, as well as desktop Office apps.</p>
<p>But there is so... <b>so</b> much more to it than just this one background service. It's not just TokenBroker, but also the entire UWP application model it rests upon is all just so over-engineered, it's Kafkaesque. (I overuse that word, but waking up as a cockroach in an airport terminal from which there is no escape fits the theme of TokenBroker perfectly.) It's complicated to the point that customers have no hope of self-resolving when problems occur with TokenBroker, and even when customers escalate their TokenBroker issues to Customer Support, Office and Windows product groups spend months pointing fingers at each other while engineers scratch their heads over logs and 6 million-line ETW traces that give no clues as to what the actual root cause of the problem may be. The interesting TokenBroker logic where authentication actually takes place doesn't even execute in the TokenBroker svchost process, but in a plugin called Microsoft.AAD.BrokerPlugin.exe. Sometimes the failure takes place there, but sometimes the failure may occur in, say for example, the underlying DCOM layer, which takes an entirely different methodology and skillset to troubleshoot. I mean, everyone has a constant stream of DCOM registration errors in their event logs, don't they? Are you desensitized to them? Would you know which ones are important and which ones aren't?</p>
<p>Before you can even begin to learn about TokenBroker, you must first learn about UWP, AppX, DCOM, sihost, broker infrastructure background task activation, and much more that you probably don't want to know.</p>
<p>By far the best resource for learning about this is chapters 7 and 8 in Part 2 of <i><a href="https://www.microsoftpressstore.com/store/windows-internals-part-1-system-architecture-processes-9780735684188">Windows Internals, 7th Ed.</a></i></p>
<p>I cannot explain it as well as Russinovich does in the book, but I will copy this one graphic just to show you how all of your Azure AD and Office authentication relies on this absolute unit full of fragile moving parts:</p>
<img src="posts/images/2024/uwpdiagram01.png" alt="activation of a modern UWP application" title="activation of a modern UWP application">
<p>When any one piece of this architecture breaks - DCOM, sihost.exe, ShellExperienceHost, AppX state repository, Explorer, Broker Infrastructure, Background Task Host, even LSA - the whole thing fails and all the end user gets is a dialog box saying "Something went wrong [1001].</p>
<p>Any time this happens, depending on where exactly the failure took place, it may have effects all across the system besides just Azure AD and Office auth failures, but also perhaps the Start Menu stops working, or maybe the taskbar starts flickering, or perhaps the new immersive control panel doesn't work anymore... all of these seemingly disparate things can be quite related... but since the first and most impactful thing customers see is "Outlook and Teams aren't signing in," the ticket comes to me.</p>
<p>The AD guy.</p>
<p><b><u>Enough background info; on to the customer case!</u></b></p>
<p>The story begins way before I ever got involved. The case went unsolved for a long time until I was called in to see if I could help.</p>
<p>Customer's description of the problem: Everything works fine for a while, then after two or three or four days, all Teams and Outlook authentication just stops working. The only way to recover is with a reboot.</p>
<p>Customer opens support case with Microsoft.</p>
<p>Front line engineers take a look and are instantly dismayed, because the TokenBroker event logs say nothing other than "I pooped my pants:"</p>
<pre>
Warning
Event ID: 1097
Source: AadTokenBrokerPlugin Operation

Error: 0x8AA9004C Acquire token by refresh token failed, trying PRT.
Logged at RefreshTokenRequest.cpp, line: 111, method: RefreshTokenRequest::AcquireToken.

Request: authority: https://login.microsoftonline.com/common, 
client: 559DB7D1-2EDC-4712-9A91-2658032C4A1B, 
redirect URI: ms-appx-web://Microsoft.AAD.BrokerPlugin/559DB7D1-2EDC-4712-9A91-2658032C4A1B, 
resource: https://dataservice.o365filtering.com, correlation ID (request): B65E5C04-3834-4BF9-AA9F-3CDF6C07CE6C
</pre>
<p>and</p>
<pre>
Error
Event ID: 1098
Source: AadTokenBrokerPlugin Operation

Error: 0xCAA2000C The request requires user interaction.
Code: interaction_required
Description: AADSTS50076: Due to a configuration change made by your administrator, or because you 
moved to a new location, you must use multi-factor authentication to access '00000007-0000-0ff1-ce00-000000000000'. 
Trace ID: ea0ea47a-298e-4bb5-8d26-7b8faf3c0800 
Correlation ID: 9a0ee8c7-7cb6-4d63-b046-270e0157293e Timestamp: 2023-11-09 05:12:27Z
TokenEndpoint: https://login.microsoftonline.com/common/oauth2/token
Logged at OAuthTokenRequestBase.cpp, line: 426, method: OAuthTokenRequestBase::ProcessOAuthResponse.

Request: authority: https://login.microsoftonline.com/common, client: 559DB7D1-2EDC-4712-9A91-2658032C4A1B, redirect URI: ms-appx-web://Microsoft.AAD.BrokerPlugin/559DB7D1-2EDC-4712-9A91-2658032C4A1B, 
resource: https://dataservice.o365filtering.com, correlation ID (request): B65E5C04-3834-4BF9-AA9F-3CDF6C07CE6C
</pre>
<p>And a couple other events that were equally as vague and useless.</p>
<p>So once event logs have failed us, we typically go in for ETW traces next, which are only readable by internal Microsoft engineers. Customers typically cannot use ETW traces of Microsoft components, because they require private symbols to decode.</p>
<p>The ETW traces gave us a couple of small breadcrumbs like this:</p>
<pre>
0x80070583 - ERROR_CLASS_DOES_NOT_EXIST

0x80070008 - ERROR_NOT_ENOUGH_MEMORY
</pre>
<p>Trying to authenticate from certain Office apps would trigger the first error in the WAM ETW logs, while trying to auth from certain other Office apps would trigger the latter error. Take into account that these error codes were embedded within ETW traces that can be actual <i>millions</i> of lines long. So definitely a needle in a very large haystack here.</p>
<p>But there was a twist -- the svchost service hosting process that hosted the TokenBroker service was also crashing too, intermittently.</p>
<p>This is what the previous engineers first chose to focus on.</p>
<p>Fast-forward a shocking amount of time, and I get a ping on Teams from a collegue asking me my opinion on this svchost crash. He told me svchost was crashing with 0x80070008, out of memory. I download the crash and take a look:</p>
<pre>
WinDbg Output:

ntdll!KiRaiseUserExceptionDispatcher
KERNELBASE!SetEvent
SHCore!WorkThreadManager::CThread::ThreadProc
SHCore!WorkThreadManager::CThread::s_ExecuteThreadProc
SHCore!&lt;lambda_9844335fc14345151eefcc3593dd6895&gt;::&lt;lambda_invoker_cdecl&gt;
kernel32!BaseThreadInitThunk
ntdll!RtlUserThreadStart
</pre>
<p>Well, first off this is not a TokenBroker crash. This is a crash in SHCore, which is not specific to TokenBroker. Various DPI-related display and text scaling functions are implemented in there... maybe some other stuff too... but certainly has nothing to do with TokenBroker, even if the module was loaded in TokenBroker's svchost process. I don't know if SHCore has a good reason to be loaded in TokenBroker's svchost or not.</p>
<p>Second, the crash was 0xc0000008, not 0x80070008. Two totally different error codes. c0000008 is Invalid Handle, while 80070008 is out of memory. I guess the previous engineers conflated the two error codes because the WAM ETW traces were showing 80070008, but then this svchost process was crashing with c0000008, which looks similar. Of course it makes no sense for the SetEvent function to fail with an out of memory error, but it makes total sense for the SetEvent function to fail with an invalid handle error if the event had already been closed. Which is what happened. It was a race condition where another thread had already set and closed this event. Then this thread came up behind it and tried to set the same event again, received the error code which ended up crashing the process.</p>
<p>BUT... that was all irrelevant anyway. It was irrelevant because A) this secondary bug had already been identified and fixed by the PG as part of a completely separate investigation during the intervening time from when the case was first opened, and when I got involved. And B) this svchost crash would have never happened, had the TokenBroker not experienced the 80070008 error in the first place. When TokenBroker experienced the 80070008 (no memory,) it sent the TokenBroker service down a certain code path that we only go down if TokenBroker failed in an unexpected way.</p>
<p>So now with the bug fix in place, svchost was no longer crashing. But the customer still had the same problem of Teams and Outlook authentication failing after a few days.</p>
<p>So I went back to thinking about the two errors seen in the WAM traces: 0x80070583 (ERROR_CLASS_DOES_NOT_EXIST) and 0x80070008 (ERROR_NOT_ENOUGH_MEMORY). I could have asked the customer for a Time Travel Debugging (TTD) trace of Microsoft.AAD.BrokerPlugin.exe, but TTD traces are always a last resort. TTD traces can be very difficult to collect, <i>especially</i> of packaged UWP apps, and even harder to analyze. Instead, let's try to make some progress the old-fashioned way: by thinking about it. Consider what ERROR_CLASS_DOES_NOT_EXIST means. When could that error code be generated? What kind of "class" is it talking about? Is it a DCOM class? Or is it a window class?</p>
<p>ERROR_CLASS_DOES_NOT_EXIST, as far as I know, means just one thing: You tried to create a window specifying a window class name that wasn't registered.</p>
<p>Which means the previous attempt at window class registration failed. Why would window class registration fail? Was it the RegisterClass Windows API function that was failing with 0x80070008 out of memory? Why would that happen?</p>
<p>The only possibilities that came to mind were A) global atom table exhaustion or B) desktop heap exhauation.</p>
<p>With that thought, I looked at the old data the customer had uploaded to Microsoft a long time ago, and found that he had already uploaded a full/complete memory dump from when the system was in state.</p>
<p>One of my collegues Dan M, once an EE like me but on the PG now, wrote a debugger extension that makes light work out of desktop heap investigations:</p>
<pre>
WinDbg Output:

================================================================
Checking session 0:

***** Session 0 logged a desktop heap allocation failure! *****
Desktop: ffffd28feba04850 Max Size:    1400000, Committed%:  0.04, Busy%:  0.04
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28feba03590 Max Size:      18000, Committed%:  8.33, Busy%:  8.33
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28feba02a50 Max Size:      30000, Committed%:  4.17, Busy%:  4.17
parse desktop heap

-----------------------------------------------------------------------------------------------------
<span style="background-color:yellow; font-weight:bold;">Desktop: ffffd28fec6a40f0 Max Size:      c0000, Committed%: 100.00, Busy%: 100.00		 ******************** Investigate!</span>
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28ff02cf7d0 Max Size:      c0000, Committed%:  2.60, Busy%:  2.60
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28ff02cec90 Max Size:      c0000, Committed%:  2.60, Busy%:  1.56
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28ff6a7fb30 Max Size:      c0000, Committed%:  1.04, Busy%:  1.04
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28ff6b43b30 Max Size:      c0000, Committed%:  1.04, Busy%:  1.04
parse desktop heap

-----------------------------------------------------------------------------------------------------

================================================================
Checking session 1:

Session 1 has NOT logged a desktop heap allocation failure.
Desktop: ffffd28fef8ce0f0 Max Size:    1400000, Committed%:  4.92, Busy%:  4.77
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28fef8cf590 Max Size:      18000, Committed%:  8.33, Busy%:  8.33
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28fef8d1570 Max Size:      30000, Committed%: 14.58, Busy%: 14.58
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28ffd2d62f0 Max Size:      c0000, Committed%:  1.04, Busy%:  1.04
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28ffb73f310 Max Size:      c0000, Committed%:  1.04, Busy%:  1.04
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28ffb521df0 Max Size:      c0000, Committed%:  1.04, Busy%:  1.04
parse desktop heap

-----------------------------------------------------------------------------------------------------
Desktop: ffffd28ff98a3670 Max Size:      c0000, Committed%:  1.04, Busy%:  1.04
parse desktop heap

-----------------------------------------------------------------------------------------------------
</pre>
<p>The default desktop in session 0, as you can see in the output above, is 100% committed. The desktop heap for session 0 is by design very small (c0000 bytes or 768 kilobytes,) because there isn't supposed to be any GUI in session 0. It's supposed to be reserved for non-interactive services. Desktop heaps for interactive users are much larger so they support a lot more open windows, menus, etc.</p>
<p>But TokenBroker does need a small amount of session 0 desktop heap. When session 0 desktop heap is exhausted, TokenBroker will fail in strange ways.</p>
<pre>
WinDbg Output:

Success! Changed to session 0

Session is DISCONNECTED with protocol: PROTOCOL_DISCONNECT.

Important Processes & Threads:
CSRSS:  ffffd28fec650080
WinLogon: 0000000000000468
gpidLogonUI is paged out or zero! Try to find LogonUI.
RawInputThread: ffffd28fedfc5080 W32: ffff998f5c344010 and input desktop is: ffffd28feba02a50

Other Win32k stuff:
gpresuser (0000000000000000) is invalid.  Could it be paged out or uninitialized?
No foreground application. (gpqforeground is NULL) 


WARNING: Session logged a desktop heap allocation failure!

Dump NTUSER handles, Dump NTGDI handles, Display win32k threads, or Dump HydraHint.

Found something interesting in session 0.

Loading handles/classes...

Type             Allocs Size     Heap Used Percent Used First Allocation Triage
================ ====== ======== ========= ============ ================ ================================================
Useless Fragment      1  32.00 B   32.00 B            0 fffff802d22b0fe0 
Useless Fragment      1  80.00 B   80.00 B            0 fffff802d22f0fb0 
Unknown               1  96.00 B   96.00 B            0 fffff802d2291030 DPS First Entry
Free                  1 128.00 B  128.00 B            0 fffff802d22e7f70 
Free                  1 144.00 B  144.00 B            0 fffff802d234ff70 
Unknown               2  80.00 B  160.00 B            0 fffff802d2293200 DPS First Entry
Unknown               5  32.00 B  160.00 B            0 fffff802d2293b10 DPS First Entry
String                2  96.00 B  192.00 B            0 fffff802d2291730 Show all strings in heap about this size.
Free                  1 192.00 B  192.00 B            0 fffff802d2291de0 
Unknown               2 112.00 B  224.00 B            0 fffff802d2291230 DPS First Entry
String                2 112.00 B  224.00 B            0 fffff802d2296110 Show all strings in heap about this size.
Free                  1 224.00 B  224.00 B            0 fffff802d229fbf0 
Free                  1 288.00 B  288.00 B            0 fffff802d22a6990 
String                2 160.00 B  320.00 B            0 fffff802d229cf90 Show all strings in heap about this size.
Free                  1 320.00 B  320.00 B            0 fffff802d22e6410 
Free                  1 336.00 B  336.00 B            0 fffff802d229a4d0 
String                6  80.00 B  480.00 B            0 fffff802d2291f50 Show all strings in heap about this size.
MENU                  8  80.00 B  640.00 B            0 fffff802d2293250 Triage menus and related structures on this heap
Useless Fragment     11  64.00 B  704.00 B            0 fffff802d2298110 
Window Class          6 128.00 B  768.00 B            0 fffff802d2296ec0 Show all window classes on this heap.
String               37  32.00 B   1.16 KB            0 fffff802d22912a0 Show all strings in heap about this size.
String               35  48.00 B   1.64 KB            0 fffff802d2291790 Show all strings in heap about this size.
String               42  64.00 B   2.62 KB            0 fffff802d2291610 Show all strings in heap about this size.
WINDOW                8 368.00 B   2.88 KB            0 fffff802d22a0e90 Show all windows in this heap.
Unknown               2  1.77 KB   3.53 KB            0 fffff802d2297710 DPS First Entry
Unknown               6 912.00 B   5.34 KB            0 fffff802d22932f0 DPS First Entry
Window Class         54 112.00 B   5.91 KB            0 fffff802d2291650 Show all window classes on this heap.
Unknown             144  64.00 B   9.00 KB            1 fffff802d2291090 DPS First Entry
<span style="background-color:yellow; font-weight:bold;">WINDOW             2066 352.00 B 710.19 KB           92 fffff802d22910d0 Show all windows in this heap.</span>
================ ====== ======== ========= ============ ================ ================================================
Type             Allocs Size     Heap Used Percent Used First Allocation Triage

Found 745.45 KB Busy bytes & 816.00 B Fragmented bytes & 1.59 KB Free bytes & 0 UnCommitted bytes  & 16.00 KB Paged Out bytes with a heap overhead of 4.05 KB.
Fragments are Free allocations which are too small to hold a window, making them nearly useless.

True % of heap used: 97.60505
Effective % of heap used: 97.70882

Some of this heap is paged out, so results are incomplete.
Paged out % of heap: 2.08363
</pre>
<p>The output above shows that there 2066 windows in session 0 consuming practically all of the desktop heap.</p>
<pre>
WinDbg Output:

Using cached handles/classes...
Failed to find window title string in the heap!

EProcess         Heap Consumed on target desktop Percent Used Process Name
================ =============================== ============ ==========================
ffffd28fef92e080                        112.00 B            0 svchost.exe
ffffd28ff06ba0c0                        144.00 B            0 svchost.exe
ffffd28ff2bd70c0                        144.00 B            0 WMIRegistrationService.exe
ffffd28ff2bd5080                        144.00 B            0 dummyService.exe
ffffd28ff2962080                        144.00 B            0 MigrationService.exe
ffffd28ff389a080                        144.00 B            0 svchost.exe
ffffd28ff87e90c0                        144.00 B            0 dummyapp.exe
ffffd28ff2696080                        160.00 B            0 svchost.exe
ffffd28ff26650c0                        576.00 B            0 svchost.exe
ffffd28feffd10c0                        624.00 B            0 SecurityHealthService.exe
ffffd28fec650080                        704.00 B            0 csrss.exe
ffffd28ff2bd1080                        736.00 B            0 pppd.exe
ffffd28ff29bd0c0                        736.00 B            0 SamsungMagicianSVC.exe
ffffd28ff28dd080                        736.00 B            0 armsvc.exe
ffffd28ff2a33080                        736.00 B            0 dummyService2.exe
ffffd28ff3592080                        736.00 B            0 unsecapp.exe
ffffd28ff29ec080                        752.00 B            0 AgentMon.exe
ffffd28ff2960080                        752.00 B            0 SentinelAgent.exe
ffffd28ff4e020c0                        752.00 B            0 dummyTrayManager.exe
ffffd28ff086c0c0                        768.00 B            0 NVDisplay.Container.exe
ffffd28ff8ef1080                        768.00 B            0 dummy3.exe
ffffd28ff2bd2080                         1.12 KB            0 RtkAudUService64.exe
ffffd28ff2bf0080                         1.33 KB            0 OfficeClickToRun.exe
ffffd28ff0b2b080                         1.62 KB            0 svchost.exe
ffffd28ff2a42080                         2.23 KB            0 AsusFanControlService.exe
ffffd28ff250e080                         2.72 KB            0 WmiPrvSE.exe
ffffd28ff2bd4080                         4.70 KB            0 svchost.exe
ffffd28ff4844080                         4.78 KB            0 conhost.exe
ffffd28ff4845080                         4.78 KB            0 conhost.exe
<span style="background-color:yellow; font-weight:bold;">ffffd28ff29c10c0                       700.97 KB           91 spoolsv.exe</span>
================ =============================== ============ ==========================
EProcess         Heap Consumed on target desktop Percent Used Process Name

Found 745.45 KB Busy bytes & 816.00 B Fragmented bytes & 1.59 KB Free bytes & 0 UnCommitted bytes  & 16.00 KB Paged Out bytes with a heap overhead of 4.05 KB.
Fragments are Free allocations which are too small to hold a window, making them nearly useless.

True % of heap used: 97.60505
Effective % of heap used: 97.70882

Some of this heap is paged out, so results are incomplete.
Paged out % of heap: 2.08363
</pre>
<p>A few process names were changed to protect the innocent.</p>
<p>All of the windows were created by spoolsv.exe. The print spooler. OF COURSE it's a ****ing printer.</p>
<pre>
WinDbg Output:

Process Name                                        PID  TID  WND Addr         SessionID Msg Queue        # MSG Post # MSG Input ThreadInfo       ProcessInfo      Title                                                                 Class Name
=================================================== ========= ================ ========= ================ ========== =========== ================ ================ ===================================================================== ================================
spoolsv.exe                                         1528 1d30 fffff802d4d4a150         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d4a000         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d4a930         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49e70         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49d20         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49bd0         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49a80         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49930         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d497e0         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49690         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49540         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d493f0         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d492a0         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49150         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d49000         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d48e70         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d48d20         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d48bd0         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d48a80         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d48930         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d487e0         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d483f0         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d482a0         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d48150         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d48000         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d47e70         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
spoolsv.exe                                         1528 1d30 fffff802d4d47d20         0 0000000000000000 0          0           ffff998f64578920 ffff998f61b93b30 <none>                                                                MGMTAPI Notification Class
... about 2000 more windows just like these...
</pre>
<p>Now we can see that all these windows in session 0 were created by the same thread, 1d30. Let's take a look at that thread:</p>
<pre>
WinDbg Output:

# Call Site
0 nt!KiSwapContext
1 nt!KiSwapThread
2 nt!KiCommitThreadWait
3 nt!KeWaitForSingleObject
4 nt!ObWaitForSingleObject
5 nt!NtWaitForSingleObject
6 nt!KiSystemServiceCopyEnd
7 ntdll!ZwWaitForSingleObject
8 KERNELBASE!WaitForSingleObjectEx
9 <span style="background-color:yellow; font-weight:bold; color:black;">HpTcpMon</span>
a KERNEL32!BaseThreadInitThunk
b ntdll!RtlUserThreadStart
</pre>
<p>All 2066 of these windows were created by a thread in spoolsv that just so happens to have HpTcpMon (a 3rd party Hewlett Packard module) on it. All of these windows were 1024x768 by the way, so you can imagine how obnoxious and obvious this problem would have been if the problem had taken place on a desktop that was actually visible to the user. It was probably trying to alert the user that they were out of cyan colored ink.</p>
<p>I know even less about printers than I do about TokenBroker, but a web search on HpTcpMon led me to <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/printing/printer-spooler-crashes-hp-printer-installed">this old KB article</a>, which explains that this is a known issue with the HpTcpMon module, that some poor engineer many years before me had already figured all this out, and the article includes steps on how to fix it!</p>
<p>The customer followed the steps in that KB article and his problem, a problem he had been having for many months, went away overnight.</p>
<p>Unfortunately, customers cannot reproduce any of the cool WinDbg stuff I performed here, because it requires private symbols. Unfortunately at this time, this type of problem can only be diagnosed for certain with a full/complete memory dump sent to Microsoft while the machine is in state. There once was a tool named dheapmon a long time ago, but from what I understand it no longer works on modern versions of Windows. It requires direct access to (and possibly patching of) kernel structures in memory that just isn't possible anymore in a regular desktop tool.</p>
<p>There is one event log event that could have helped:</p>
<pre>
Log Name:      System
Source:        Win32k
Date:          2013-04-11 10:12:31 AM
Event ID:      243
Task Category: None
Level:         Warning
Keywords:      Classic
User:          N/A
Computer:      host01.domain.com
Description:
A desktop heap allocation failed.
</pre>
<p>But this event was not being logged consistently, and the event was not being logged at a time where anyone would have correllated it with a TokenBroker authentication failure. Only in hindsight did anyone pay any attention to these events or could have imagined that they would have anything to do with not being able to sign in to Teams or Outlook.</p>
<p>A printer was causing this guy to not be able to sign in to Teams or Outlook.</p>
<p>And it took the AD guy to find it.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>BONUS CONTENT: There is also another variant of this problem that I have encountered in the wild. Instead of all the session 0 desktop heap being consumed by a single process, you might instead see hundreds of processes like these running in session 0:</p>
<pre>
0x49ec 0n18924 ffffc5829918c080 conhost.exe                                                              0
0x392c 0n14636 ffffc5829a661080 reg.exe                                                                  0
0x4fd8 0n20440 ffffc58297fef0c0 powershell.exe                                                           0
0x613c 0n24892 ffffc5829baf30c0 conhost.exe                                                              0
0x6114 0n24852 ffffc5829bded0c0 reg.exe                                                                  0
0x33f0 0n13296 ffffc582997c10c0 powershell.exe                                                           0
0x1764 0n5988  ffffc5829bcd20c0 conhost.exe                                                              0
0x6374 0n25460 ffffc582992890c0 reg.exe                                                                  0
0x6384 0n25476 ffffc58298eca0c0 powershell.exe                                                           0
0x4fd0 0n20432 ffffc582991f40c0 conhost.exe                                                              0
0x6140 0n24896 ffffc582944790c0 reg.exe                                                                  0
0x5da4 0n23972 ffffc58294d680c0 powershell.exe                                                           0
0x1644 0n5700  ffffc582979160c0 conhost.exe                                                              0
0x5b84 0n23428 ffffc5829bfc50c0 reg.exe                                                                  0
0x53e4 0n21476 ffffc5829bcd50c0 powershell.exe                                                           0
0x59d8 0n23000 ffffc5829917f080 conhost.exe                                                              0
0x60f0 0n24816 ffffc58298f71080 reg.exe                                                                  0
0x7d8  0n2008  ffffc5829bce6080 powershell.exe                                                           0
0x2ee0 0n12000 ffffc5828cef0080 conhost.exe                                                              0
0x4c40 0n19520 ffffc58295d94080 reg.exe                                                                  0
0x52c8 0n21192 ffffc582994490c0 powershell.exe                                                           0
0x606c 0n24684 ffffc5829ba230c0 conhost.exe                                                              0
0x1ad4 0n6868  ffffc582995f80c0 reg.exe                                                                  0
0x5aac 0n23212 ffffc5829a1b4080 powershell.exe                                                           0
0x4c80 0n19584 ffffc58299182080 conhost.exe                                                              0
0x61dc 0n25052 ffffc582952b1080 reg.exe                                                                  0
0x678c 0n26508 ffffc5829b92e080 powershell.exe                                                           0
0x6534 0n25908 ffffc5829c7e7080 conhost.exe                                                              0
0x6314 0n25364 ffffc5829cb43080 reg.exe                                                                  0
0x66b0 0n26288 ffffc5829cc87080 powershell.exe                                                           0
0x3b00 0n15104 ffffc5829cb61080 conhost.exe                                                              0
0x5720 0n22304 ffffc5829cd3b080 reg.exe                                                                  0
0x331c 0n13084 ffffc5829d147140 powershell.exe                                                           0
0x3480 0n13440 ffffc5829b8f0140 conhost.exe                                                              0
0x6824 0n26660 ffffc5829cc5e0c0 reg.exe                                                                  0
0x68d4 0n26836 ffffc5829d5240c0 powershell.exe                                                           0
0x5510 0n21776 ffffc5829d0a10c0 conhost.exe                                                              0
0x6740 0n26432 ffffc5829cdb40c0 reg.exe                                                                  0
0x1954 0n6484  ffffc5829ce92080 powershell.exe                                                           0
0x6348 0n25416 ffffc5829cf1f080 conhost.exe                                                              0
...plus dozens more...
</pre>
<p>In this situation, the user had a script that was being pushed by Group Policy. This script consisted of just two simple reg.exe commands. One of those commands was causing the script to hang, like this:</p>
<img src="posts/images/2024/reg.exe01.png" alt="reg.exe export overwrite" title="reg.exe export overwrite">
<p>The script hung indefinitely due to a prompt that the user could never respond to because it was in session 0. Every GPO refresh interval, a new instance of the script would start again, in session 0. Every time the script started, new conhost and PowerShell windows were created in session 0, each requiring a tiny amount of desktop heap, until it was depleted.</p>